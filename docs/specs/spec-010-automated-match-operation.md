# Spec-010: 자동 경기 운영 시스템

## 개요
경기도 e스포츠협회 포털(portal.gesports.kr)에서 경기를 자동으로 생성, 스케줄링, 녹화/스트리밍, 유튜브 업로드까지 완전 자동화하는 시스템

## 핵심 목표
- **무인 운영**: 경기 생성부터 영상 업로드까지 최소한의 인력 개입으로 운영
- **주기적 경기**: 정기 대회(매주 화/목 20:00 등) 자동 생성
- **자동 녹화/스트리밍**: OBS를 통한 자동 라이브 송출 및 VOD 생성
- **리플레이 백업**: 라이브 실패 시 리플레이 기반 VOD 재생성

## 기능 요구사항

### 10.1 자동 경기 스케줄링

#### 10.1.1 정기 대회 자동 생성
- **스케줄러 기반**: 크론 작업으로 주기적 경기 생성
- **룰 기반 생성**:
  - 예: "매주 화요일/목요일 20:00"
  - 예: "매월 첫째 주 토요일 14:00"
  - 예: "매일 19:00"
- **대진표 기반**: 토너먼트 대진 생성 시 자동으로 경기 슬롯 생성
- **신청 기반**: 참가 신청 마감 시점에 자동 편성 및 공지 생성

#### 10.1.2 경기 정보 자동 생성
- 경기명 (예: "2024 경기도 아마추어 리그 - 1주차")
- 게임 카테고리 (LoL, VALORANT)
- 경기 일시
- 참가팀/선수 정보
- 게임 룸 코드/디스코드 링크
- 중계PC 정보

### 10.2 자동 스트리밍/녹화 시스템

#### 10.2.1 YouTube 라이브 자동 생성
- **경기 생성 시**: YouTube Live API로 예약 방송 자동 생성
- **방송 정보**:
  - 제목: "{경기명} - {게임} 경기"
  - 설명: 경기 정보, 참가팀, 일정 등
  - 썸네일: 자동 생성 또는 템플릿 사용
  - 태그: 게임명, 대회명 등
  - 자동 녹화 설정: `recordFromStart` 활성화
- **스트림키 관리**: 경기별 고유 스트림키 매핑

#### 10.2.2 OBS 자동 제어
- **중계PC 요구사항**:
  - 상시 운영 가능한 전원/네트워크
  - 원격 접속 가능
  - OBS Studio 설치
  - 게임 클라이언트 (LoL, VALORANT) 설치

- **자동 시작/종료 플로우**:
  1. 경기 시작 10분 전: 웹훅/API로 중계PC에 알림
  2. OBS 자동 실행 (또는 이미 실행 중)
  3. 해당 경기 프로파일/장면(Scene) 로드
  4. 스트림키 설정 및 스트리밍 시작
  5. 경기 종료 시: 스트리밍 종료
  6. 상태를 포털에 업데이트

- **OBS 제어 방식**:
  - OBS WebSocket API 사용
  - 또는 OBS CLI 스크립트
  - 또는 중계PC에 설치된 에이전트 프로그램

#### 10.2.3 게임 화면 캡처
- **LoL (리그 오브 레전드)**:
  - 커스텀 게임 관전자(Observer/Spectator) 모드 사용
  - 관전자 클라이언트로 화면 캡처
  - 리플레이 다운로드 가능

- **VALORANT (발로란트)**:
  - 커스텀 게임 토너먼트 모드 옵저버 슬롯 활용
  - 옵저버 화면 캡처
  - 공식 리플레이 시스템 활용 (Patch 11.06+)

#### 10.2.4 자동화 제약사항
- **완전 자동화 가능**:
  - 경기 생성 및 스케줄링
  - YouTube 라이브 생성
  - OBS 스트리밍 시작/종료
  - VOD 자동 생성 및 링크 매핑

- **부분 자동화/수동 개입 필요**:
  - 옵저버 카메라 전환 (VALORANT는 특히)
  - 실시간 오버레이/데이터 표시 (안티치트 제약)
  - 경기 화면 품질 관리

### 10.3 리플레이 기반 백업 시스템

#### 10.3.1 리플레이 수집
- **LoL 리플레이**:
  - 경기 종료 후 클라이언트에서 리플레이 다운로드
  - 자동 다운로드 스크립트 또는 API 활용
  - 리플레이 파일 저장

- **VALORANT 리플레이**:
  - 공식 리플레이 시스템 활용
  - 커스텀 게임 리플레이 저장 (Patch 12.00+)
  - 리플레이 파일/데이터 수집

#### 10.3.2 리플레이 기반 VOD 재생성
- **시나리오**: 라이브 스트리밍 실패 또는 품질 문제
- **프로세스**:
  1. 리플레이 파일 확인
  2. OBS로 리플레이 재생 및 녹화
  3. 후처리 (선택사항)
  4. YouTube에 업로드
  5. 포털 경기 페이지에 VOD 링크 연결

#### 10.3.3 하이라이트 자동 생성 (선택사항)
- 리플레이 구간 지정
- 킬/라운드 이벤트 자동 인식 (고급)
- OBS/렌더링 자동 녹화
- 하이라이트 클립 업로드

### 10.4 경기 상태 관리

#### 10.4.1 경기 상태 머신
- `scheduled`: 예약됨 (경기 생성)
- `youtube_created`: YouTube 라이브 생성 완료
- `streaming_ready`: OBS 준비 완료
- `live`: 라이브 중
- `completed`: 경기 종료
- `vod_available`: VOD 생성 완료
- `replay_backup`: 리플레이 백업 완료
- `failed`: 실패 (재시도 필요)

#### 10.4.2 자동 재시도 로직
- 스트리밍 시작 실패 시 재시도
- YouTube 업로드 실패 시 재시도
- 리플레이 다운로드 실패 시 재시도
- 최대 재시도 횟수 설정

### 10.5 알림 시스템
- 경기 생성 알림 (참가자, 관리자)
- 경기 시작 전 알림 (10분 전, 1시간 전)
- 스트리밍 시작 알림
- VOD 업로드 완료 알림
- 오류 발생 알림 (관리자)

## 기술 구현

### 10.6 아키텍처

#### 10.6.1 포털 서버
- 경기 생성/관리 API
- 스케줄러 (크론 작업)
- 이벤트 기반 처리 (경기 생성 → YouTube 생성 → OBS 트리거)
- 상태 관리 및 모니터링

#### 10.6.2 중계PC 에이전트
- OBS WebSocket 클라이언트
- 게임 클라이언트 제어
- 웹훅 수신 및 실행
- 상태 리포트 전송

#### 10.6.3 외부 서비스 연동
- YouTube Live API
- YouTube Data API (VOD 업로드)
- 게임 클라이언트 API (리플레이 다운로드)

### 10.7 데이터베이스 설계

- `match_schedules` 테이블
  - id (PK)
  - tournament_id (FK, optional)
  - game_category
  - match_name
  - scheduled_at
  - status (scheduled, live, completed, failed)
  - youtube_live_id
  - youtube_vod_id
  - replay_file_path
  - obs_status
  - created_at
  - updated_at

- `match_participants` 테이블
  - id (PK)
  - match_id (FK)
  - user_id 또는 team_id (FK)
  - role (player, observer)
  - game_room_code
  - created_at

- `match_streaming_logs` 테이블
  - id (PK)
  - match_id (FK)
  - action (start, stop, error)
  - obs_status
  - youtube_status
  - error_message
  - created_at

- `replay_files` 테이블
  - id (PK)
  - match_id (FK)
  - game_category
  - file_path
  - file_size
  - download_status
  - created_at

## 운영 체크리스트

### 10.8 필수 확인 사항
- [ ] 경기 영상에 대한 선수/참가자 동의서
- [ ] 초상권/저작권 정리 (게임 BGM, 음악, 중계 화면)
- [ ] 중계PC 상시 운영 가능 여부 (전원, 네트워크, 원격 접속)
- [ ] 게임 클라이언트 업데이트 관리
- [ ] YouTube API 할당량 관리
- [ ] 리플레이 저장소 용량 관리

### 10.9 게임별 특수 사항

#### LoL (리그 오브 레전드)
- ✅ 관전자 모드 안정적
- ✅ 리플레이 다운로드 가능
- ⚠️ 패치 변경 시 예전 리플레이 재생 제한
- ⚠️ 실시간 데이터 기반 오버레이 제한 (Vanguard)

#### VALORANT (발로란트)
- ✅ 커스텀 게임 토너먼트 모드 지원
- ✅ 공식 리플레이 시스템 (Patch 11.06+)
- ✅ 커스텀 게임 리플레이 (Patch 12.00+)
- ⚠️ 옵저버 모드 제한적 (카메라 전환 등)
- ⚠️ 실시간 데이터 기반 자동 오버레이 제약

## 구현 우선순위

### Phase 1: MVP
1. 포털에 경기 페이지 생성 (일정/대진/공지/영상 링크)
2. 관리자에서 경기 등록 시 즉시 노출
3. YouTube 예약 방송 생성 자동화
4. OBS 수동 송출로 테스트

### Phase 2: 자동화
1. OBS 자동 시작/종료 구현
2. 스케줄러 기반 경기 자동 생성
3. VOD 자동 링크 매핑

### Phase 3: 고도화
1. 리플레이 백업 시스템
2. 하이라이트 자동 생성
3. 알림 시스템 완성
4. 모니터링 및 대시보드
